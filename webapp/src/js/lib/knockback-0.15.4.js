// Generated by CoffeeScript 1.3.3

/*
  knockback.js 0.15.4
  (c) 2011, 2012 Kevin Malakoff.
  Knockback.js is freely distributable under the MIT license.
  See the following for full license details:
    https://github.com/kmalakoff/knockback/blob/master/LICENSE
  Dependencies: Knockout.js, Backbone.js, and Underscore.js.
    Optional dependency: Backbone.ModelRef.js.
*/(function(){var e,t,n,r,i,s={}.hasOwnProperty,o=function(e,t){function r(){this.constructor=e}for(var n in t)s.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};if(typeof require!="undefined")try{i=require("lodash")}catch(u){i=require("underscore")}else i=this._;i&&i.hasOwnProperty("_")&&(i=i._),e=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,r=!this.ko&&typeof require!="undefined"?require("knockout"):this.ko,t=n=this.Knockback=this.kb=typeof exports!="undefined"?exports:{},n.VERSION="0.15.4",n.locale_manager=void 0,n.stats={collection_observables:0,view_models:0},n.stats_on=!1,n.utils={},n.utils.legacyWarning=function(e,t,r){var i;return n._legacy_warnings||(n._legacy_warnings={}),(i=n._legacy_warnings)[e]||(i[e]=0),n._legacy_warnings[e]++,console.warn("warning: '"+e+"' has been deprecated (will be removed in Knockback "+t+"). "+r+".")},n.utils.wrappedObservable=function(e,t){if(arguments.length===1){if(!(e&&e.__kb&&e.__kb.observable))throw"Knockback: instance is not wrapping an observable";return e.__kb.observable}if(!e)throw"Knockback: no instance for wrapping a observable";return e.__kb||(e.__kb={}),e.__kb.observable&&e.__kb.observable.__kb&&(e.__kb.observable.__kb.instance=null),e.__kb.observable=t,t&&(t.__kb||(t.__kb={}),t.__kb.instance=e),t},n.wrappedObservable=function(e){return n.utils.legacyWarning("kb.wrappedObservable","0.16.0","Please use kb.utils.wrappedObservable instead"),n.utils.wrappedObservable(e)},n.utils.observableInstanceOf=function(e,t){return e?!e.__kb||!e.__kb.instance?!1:e.__kb.instance instanceof t:!1},n.utils.wrappedModel=function(e,t){if(arguments.length===1)return e&&e.__kb&&e.__kb.hasOwnProperty("model")?e.__kb.model:e;if(!e)throw"Knockback: no view_model for wrapping a model";return e.__kb||(e.__kb={}),e.__kb.model=t,t},n.viewModelGetModel=n.vmModel=function(e){return n.utils.legacyWarning("kb.vmModel","0.16.0","Please use kb.utils.wrappedModel instead"),n.utils.wrappedModel(e)},n.utils.setToDefault=function(e){var t,s,o;if(!e)return;if(r.isObservable(e))return typeof e.setToDefault=="function"?e.setToDefault():void 0;if(i.isObject(e)){o=[];for(t in e)s=e[t],o.push(s&&t!=="__kb"?n.utils.setToDefault(s):void 0);return o}},n.vmSetToDefault=function(e){return n.utils.legacyWarning("kb.vmSetToDefault","0.16.0","Please use kb.utils.release instead"),n.utils.setToDefault(e)},n.utils.release=function(e,t){var s,o;if(!e)return!1;if(!t&&(r.isObservable(e)||e instanceof n.Observables||typeof e.release=="function"||typeof e.destroy=="function"))return e.release?e.release():e.destroy?e.destroy():e.dispose&&e.dispose(),!0;if(i.isObject(e)&&typeof e!="function"){for(s in e){o=e[s];if(!o||s==="__kb")continue;n.utils.release(o)&&(e[s]=null)}return!0}return!1},n.vmRelease=function(e){return n.utils.legacyWarning("kb.vmRelease","0.16.0","Please use kb.utils.release instead"),n.utils.release(e)},n.vmReleaseObservable=function(e){return n.utils.legacyWarning("kb.vmReleaseObservable","0.16.0","Please use kb.utils.release instead"),n.utils.release(e)},n.utils.optionsCreateClear=function(e){return delete e.create,delete e.children,delete e.view_model,delete e.view_model_create},n.utils.optionsCreateOverride=function(e,t){return n.utils.optionsCreateClear(e),i.extend(e,t)},n.RefCountable=function(){function t(){this.__kb||(this.__kb={}),this.__kb.ref_count=1}return t.extend=e.Model.extend,t.prototype.__destroy=function(){},t.prototype.retain=function(){if(this.__kb.ref_count<=0)throw"RefCountable: ref_count is corrupt: "+this.__kb.ref_count;return this.__kb.ref_count++,this},t.prototype.release=function(){if(this.__kb.ref_count<=0)throw"RefCountable: ref_count is corrupt: "+this.__kb.ref_count;return this.__kb.ref_count--,this.__kb.ref_count||this.__destroy(),this},t.prototype.refCount=function(){return this.__kb.ref_count},t}(),n.Store=function(){function e(){this.keys=[],this.values=[]}return e.prototype.destroy=function(){var e,t,r,i;this.keys=null,r=this.values;for(e in r){t=r[e];if(!n.utils.observableInstanceOf(t,n.CollectionObservable))continue;this.values[e]=null;while(t.refCount()>0)t.release()}i=this.values;for(e in i){t=i[e];if(!t)continue;this.values[e]=null;if(t instanceof n.RefCountable)while(t.refCount()>0)t.release();else n.utils.release(t)}return this.values=null},e.prototype.registerValue=function(e,t){var r;return t instanceof n.RefCountable&&t.retain(),r=i.indexOf(this.keys,e),r>=0?this.values[r]=t:(this.keys.push(e),this.values.push(t)),t},e.prototype.resolveValue=function(e,t,r){var s,o;s=i.indexOf(this.keys,e);if(s>=0){if(this.values[s]){if(!(this.values[s]instanceof n.RefCountable&&this.values[s].refCount()<=0))return this.values[s]instanceof n.RefCountable?this.values[s].retain():this.values[s];this.values[s]=null}}else s=this.keys.length,this.keys.push(e),this.values.push(void 0);return o=t.apply(null,Array.prototype.slice.call(arguments,2)),this.keys[s]!==e?this.registerValue(e,o):this.values[s]||(o instanceof n.RefCountable&&o.retain(),this.values[s]=o),o},e.prototype.releaseValue=function(e){var t;if(e instanceof n.RefCountable){e.release();if(e.refCount()>0)return;t=i.indexOf(this.values,e);if(t>=0)return this.values[t]=0;return}return},e.prototype.addResolverToOptions=function(e,t){return i.extend(e,{store:this,store_key:t})},e.resolveFromOptions=function(e,t){if(!e.store||!e.store_key)return;return e.store.registerValue(e.store_key,t)},e}(),n.CollectionObservable=function(e){function t(e,s){var o,u,a=this;s==null&&(s={});if(!e)throw"CollectionObservable: collection is missing";t.__super__.constructor.apply(this,arguments),n.stats_on&&n.stats.collection_observables++,r.isObservable(s)&&s.hasOwnProperty("indexOf")?(n.utils.legacyWarning("kb.collectionObservable with an external ko.observableArray","0.16.0","Please use the kb.collectionObservable directly instead of passing a ko.observableArray"),u=n.utils.wrappedObservable(this,s),s=arguments[2]||{},o=!0):u=n.utils.wrappedObservable(this,r.observableArray([])),s.store_skip_resolve||n.Store.resolveFromOptions(s,n.utils.wrappedObservable(this)),s.store?this.__kb.store=s.store:(this.__kb.store=new n.Store,this.__kb.store_is_owned=!0);if(s.hasOwnProperty("view_model")){if(!s.view_model)throw"kb.CollectionObservable: options.view_model is empty";this.view_model_create_fn=s.view_model,this.view_model_create_with_new=!0}else if(s.hasOwnProperty("view_model_constructor")){if(!s.view_model_constructor)throw"kb.CollectionObservable: options.view_model_constructor is empty";n.utils.legacyWarning("kb.collectionObservable option view_model_constructor","0.16.0","Please use view_model option instead"),this.view_model_create_fn=s.view_model_constructor,this.view_model_create_with_new=!0}else if(s.hasOwnProperty("view_model_create")){if(!s.view_model_create)throw"kb.CollectionObservable: options.view_model_create is empty";this.view_model_create_fn=s.view_model_create}else if(s.hasOwnProperty("create")){if(!s.create)throw"kb.CollectionObservable: options.create is empty";this.view_model_create_fn=s.create}return this.sort_attribute=s.sort_attribute,this.sorted_index=s.sorted_index,this.__kb._onCollectionReset=i.bind(this._onCollectionReset,this),this.__kb._onCollectionResort=i.bind(this._onCollectionResort,this),this.__kb._onModelAdd=i.bind(this._onModelAdd,this),this.__kb._onModelRemove=i.bind(this._onModelRemove,this),this.__kb._onModelChange=i.bind(this._onModelChange,this),o&&e&&e.bind("change",function(){return n.utils.wrappedObservable(a).valueHasMutated()}),u.retain=i.bind(this.retain,this),u.refCount=i.bind(this.refCount,this),u.release=i.bind(this.release,this),u.collection=i.bind(this.collection,this),u.viewModelByModel=i.bind(this.viewModelByModel,this),u.sortedIndex=i.bind(this.sortedIndex,this),u.sortAttribute=i.bind(this.sortAttribute,this),u.hasViewModels=i.bind(this.hasViewModels,this),u.bind=i.bind(this.bind,this),u.unbind=i.bind(this.unbind,this),u.trigger=i.bind(this.trigger,this),this.collection(e,{silent:!0,defer:s.defer}),u}return o(t,e),t.prototype.__destroy=function(){this.collection(null),this.hasViewModels()&&this.__kb.store_is_owned&&(this.__kb.store.destroy(),this.__kb.store=null),this.view_model_create_fn=null,this.__kb.collection=null,n.utils.wrappedObservable(this,null),t.__super__.__destroy.apply(this,arguments);if(n.stats_on)return n.stats.collection_observables--},t.prototype.retain=function(){return t.__super__.retain.apply(this,arguments),n.utils.wrappedObservable(this)},t.prototype.release=function(){var e;return e=n.utils.wrappedObservable(this),t.__super__.release.apply(this,arguments),e},t.prototype.collection=function(e,t){var r,i,s;r=n.utils.wrappedObservable(this);if(arguments.length===0)return r(),this.__kb.collection;if(e===this.__kb.collection)return;this.__kb.collection&&(this._clear(),this._collectionUnbind(this.__kb.collection),typeof (i=this.__kb.collection).release=="function"&&i.release(),this.__kb.collection=null),this.__kb.collection=e;if(this.__kb.collection)return typeof (s=this.__kb.collection).retain=="function"&&s.retain(),this._collectionBind(this.__kb.collection),this.sortedIndex(this.sorted_index,this.sort_attribute,t)},t.prototype.sortedIndex=function(e,t,r){var s,o=this;return r==null&&(r={}),e?(this.sorted_index=e,this.sort_attribute=t):t?(this.sort_attribute=t,this.sorted_index=this._sortAttributeFn(t)):(this.sort_attribute=null,this.sorted_index=null),s=function(){var e;e=n.utils.wrappedObservable(o);if(o.__kb.collection.models.length===0&&e().length===0)return;o._collectionResync(!0);if(!r.silent)return o.trigger("resort",e())},r.defer?i.defer(s):s(),this},t.prototype.sortAttribute=function(e,t,n){return this.sortedIndex(t,e,n)},t.prototype.viewModelByModel=function(e){var t,r;return this.hasViewModels()?(r=n.utils.wrappedObservable(this),t=e.hasOwnProperty(e.idAttribute)?e.idAttribute:"cid",i.find(r(),function(n){return n.__kb.model[t]===e[t]})):null},t.prototype.hasViewModels=function(){return!!this.view_model_create_fn},t.prototype._collectionBind=function(e){var t,n,r,i,s,o,u;if(!e)return;e.bind("reset",this.__kb._onCollectionReset),this.sorted_index||e.bind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.bind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.bind(t,this.__kb._onModelRemove);return e.bind("change",this.__kb._onModelChange)},t.prototype._collectionUnbind=function(e){var t,n,r,i,s,o,u;if(!e)return;e.unbind("reset",this.__kb._onCollectionReset),this.sorted_index||e.unbind("resort",this.__kb._onCollectionResort),o=["new","add"];for(n=0,i=o.length;n<i;n++)t=o[n],e.unbind(t,this.__kb._onModelAdd);u=["remove","destroy"];for(r=0,s=u.length;r<s;r++)t=u[r],e.unbind(t,this.__kb._onModelRemove);return e.unbind("change",this.__kb._onModelChange)},t.prototype._onCollectionReset=function(){return this._collectionResync()},t.prototype._onCollectionResort=function(e){var t;if(this.sorted_index)throw"CollectionObservable: collection sorted_index unexpected";return i.isArray(e)?(t=n.utils.wrappedObservable(this),this.trigger("resort",t())):this._onModelResort(e)},t.prototype._onModelAdd=function(e){var t,r,i;return i=this.hasViewModels()?this._createTarget(e):e,r=n.utils.wrappedObservable(this),this.sorted_index?t=this.sorted_index(r(),i):t=this.__kb.collection.indexOf(e),r.splice(t,0,i),this.trigger("add",i,r())},t.prototype._onModelRemove=function(e){var t,r;r=this.hasViewModels()?this.viewModelByModel(e):e;if(!r)return;t=n.utils.wrappedObservable(this),t.remove(r),this.trigger("remove",r,t);if(this.hasViewModels())return this.__kb.store.releaseValue(r)},t.prototype._onModelChange=function(e){if(this.sorted_index&&(!this.sort_attribute||e.hasChanged(this.sort_attribute)))return this._onModelResort(e)},t.prototype._onModelResort=function(e){var t,r,s,o,u;r=n.utils.wrappedObservable(this),u=this.hasViewModels()?this.viewModelByModel(e):e,s=r.indexOf(u),this.sorted_index?(o=i.clone(r()),o.splice(s,1),t=this.sorted_index(o,u)):t=this.__kb.collection.indexOf(e);if(s===t)return;return r.splice(s,1),r.splice(t,0,u),this.trigger("resort",u,r(),t)},t.prototype._clear=function(e){var t,r,i,s,o,u;t=n.utils.wrappedObservable(this),e||this.trigger("remove",t()),i=t.removeAll();if(this.hasViewModels()){u=[];for(s=0,o=i.length;s<o;s++)r=i[s],u.push(this.__kb.store.releaseValue(r));return u}},t.prototype._collectionResync=function(e){var t,r,s,o,u,a,f,l,c=this;this._clear(e),s=n.utils.wrappedObservable(this);if(this.sorted_index){u=[],l=this.__kb.collection.models;for(a=0,f=l.length;a<f;a++)r=l[a],o=this._createTarget(r),t=this.sorted_index(u,o),u.splice(t,0,o)}else u=this.hasViewModels()?i.map(this.__kb.collection.models,function(e){return c._createTarget(e)}):i.clone(this.__kb.collection.models);s(u);if(!e)return this.trigger("add",s())},t.prototype._sortAttributeFn=function(e){return this.hasViewModels()?function(t,r){return i.sortedIndex(t,r,function(t){return n.utils.wrappedModel(t).get(e)})}:function(t,n){return i.sortedIndex(t,n,function(t){return t.get(e)})}},t.prototype._createTarget=function(e){var t,r=this;return t=function(){var t,i,s;return i=r.__kb.store.addResolverToOptions({},e),t=n.utils.wrappedObservable(r),s=r.view_model_create_with_new?new r.view_model_create_fn(e,i,t):r.view_model_create_fn(e,i,t),n.utils.wrappedModel(s,e),s},this.hasViewModels()?this.__kb.store.resolveValue(e,t):e},t}(n.RefCountable),o(n.CollectionObservable.prototype,e.Events),n.collectionObservable=function(e,t,r){return new n.CollectionObservable(e,t,r)},n.sortedIndexWrapAttr=n.siwa=function(e,t){return function(r,s){return i.sortedIndex(r,s,function(r){return new t(n.utils.wrappedModel(r).get(e))})}},n.DefaultWrapper=function(){function e(e,t){var s,o=this;return this.default_value_observable=t,this.__kb={},s=n.utils.wrappedObservable(this,r.dependentObservable({read:function(){var t,n;return n=r.utils.unwrapObservable(e()),t=r.utils.unwrapObservable(o.default_value_observable),n?n:t},write:function(t){return e(t)}})),s.destroy=i.bind(this.destroy,this),s.setToDefault=i.bind(this.setToDefault,this),s}return e.prototype.destroy=function(){return n.utils.wrappedObservable(this,null),this.default_value=null},e.prototype.setToDefault=function(){var e;return e=n.utils.wrappedObservable(this),e(this.default_value_observable)},e}(),n.defaultWrapper=function(e,t){return new n.DefaultWrapper(e,t)},n.toFormattedString=function(e){var t,n,i,s,o,u;o=e.slice(),n=Array.prototype.slice.call(arguments,1);for(i in n){t=n[i],u=r.utils.unwrapObservable(t),u||(u=""),s=e.indexOf("{"+i+"}");while(s>=0)o=o.replace("{"+i+"}",u),s=e.indexOf("{"+i+"}",s+1)}return o},n.parseFormattedString=function(e,t){var n,r,s,o,u,a,f,l,c,h,p,d,v,m;h=t.slice(),s=0,a=0,l={};while(h.search("\\{"+s+"\\}")>=0){f=t.indexOf("{"+s+"}");while(f>=0)h=h.replace("{"+s+"}","(.*)"),l[f]=s,a++,f=t.indexOf("{"+s+"}",f+1);s++}n=s,c=new RegExp(h),u=c.exec(e),u&&u.shift();if(!u||u.length!==a)return i.map(function(){m=[];for(var e=1;1<=n?e<=n:e>=n;1<=n?e++:e--)m.push(e);return m}.apply(this),function(){return""});d=i.sortBy(i.keys(l),function(e,t){return parseInt(e,10)}),r={};for(o in d){f=d[o],s=l[f];if(r.hasOwnProperty(s))continue;r[s]=o}p=[],s=0;while(s<n)p.push(u[r[s]]),s++;return p},n.FormattedObservable=function(){function e(e,t){var s,o;return this.__kb={},i.isArray(t)?(e=e,o=t):o=Array.prototype.slice.call(arguments,1),s=n.utils.wrappedObservable(this,r.dependentObservable({read:function(){var i,s,u;t=[r.utils.unwrapObservable(e)];for(s=0,u=o.length;s<u;s++)i=o[s],t.push(r.utils.unwrapObservable(i));return n.toFormattedString.apply(null,t)},write:function(t){var i,s,u,a;s=n.parseFormattedString(t,r.utils.unwrapObservable(e)),u=Math.min(o.length,s.length),i=0,a=[];while(i<u)o[i](s[i]),a.push(i++);return a}})),s}return e.prototype.destroy=function(){return n.utils.wrappedObservable(this,null)},e}(),n.formattedObservable=function(e,t){return new n.FormattedObservable(e,Array.prototype.slice.call(arguments,1))},n.LocalizedObservable=function(){function t(e,t,s){var o;this.value=e,this.options=t!=null?t:{},this.view_model=s!=null?s:{};if(!this.options.read&&!this.read)throw"LocalizedObservable: options.read is missing";if(this.options.read&&this.read)throw"LocalizedObservable: options.read and read class function exist. You need to choose one.";if(this.options.write&&this.write)throw"LocalizedObservable: options.write and write class function exist. You need to choose one.";if(!n.locale_manager)throw"LocalizedObservable: kb.locale_manager is not defined";this.__kb={},this.__kb._onLocaleChange=i.bind(this._onLocaleChange,this),this.value&&(e=r.utils.unwrapObservable(this.value)),this.__kb.value_observable=r.observable(e?this.read.call(this,e,null):this._getDefaultValue());if(this.write&&typeof this.write!="function")throw"LocalizedObservable: options.write is not a function for read_write model attribute";return o=n.utils.wrappedObservable(this,r.dependentObservable({read:i.bind(this._onGetValue,this),write:this.write?i.bind(this._onSetValue,this):function(){throw"kb.LocalizedObservable: value is read only"},owner:this.view_model})),o.destroy=i.bind(this.destroy,this),o.observedValue=i.bind(this.observedValue,this),o.setToDefault=i.bind(this.setToDefault,this),o.resetToCurrent=i.bind(this.resetToCurrent,this),n.locale_manager.bind("change",this.__kb._onLocaleChange),o}return t.extend=e.Model.extend,t.prototype.destroy=function(){return n.locale_manager.unbind("change",this.__kb._onLocaleChange),this.__kb.value_observable=null,n.utils.wrappedObservable(this).dispose(),n.utils.wrappedObservable(this,null),this.options={},this.view_model=null,this.__kb=null},t.prototype.setToDefault=function(){var e,t;if(!this["default"])return;return t=this._getDefaultValue(),e=this.__kb.value_observable(),e!==t?this._onSetValue(t):this.__kb.value_observable.valueHasMutated()},t.prototype.resetToCurrent=function(){return this.__kb.value_observable(null),this._onSetValue(this._getCurrentValue())},t.prototype.observedValue=function(e){return arguments.length===0?this.value:(this.value=e,this._onLocaleChange(),this)},t.prototype._getDefaultValue=function(){return this["default"]?typeof this["default"]=="function"?this["default"]():this["default"]:""},t.prototype._getCurrentValue=function(){var e;return e=n.utils.wrappedObservable(this),!this.value||!e?this._getDefaultValue():this.read.call(this,r.utils.unwrapObservable(this.value))},t.prototype._onGetValue=function(){return this.value&&r.utils.unwrapObservable(this.value),this.__kb.value_observable()},t.prototype._onSetValue=function(e){this.write.call(this,e,r.utils.unwrapObservable(this.value)),e=this.read.call(this,r.utils.unwrapObservable(this.value)),this.__kb.value_observable(e);if(this.options.onChange)return this.options.onChange(e)},t.prototype._onLocaleChange=function(){var e;e=this.read.call(this,r.utils.unwrapObservable(this.value)),this.__kb.value_observable(e);if(this.options.onChange)return this.options.onChange(e)},t}(),n.localizedObservable=function(e,t,r){return new n.LocalizedObservable(e,t,r)},n.Observable=function(){function t(t,s,o){var u,a=this;this.model=t,this.mapping_info=s,this.view_model=o!=null?o:{};if(!this.model)throw"Observable: model is missing";if(!this.mapping_info)throw"Observable: mapping_info is missing";if(i.isString(this.mapping_info)||r.isObservable(this.mapping_info))this.mapping_info={key:this.mapping_info};if(!this.mapping_info.key)throw"Observable: mapping_info.key is missing";return this.__kb={},this.__kb._onModelChange=i.bind(this._onModelChange,this),this.__kb._onModelLoaded=i.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=i.bind(this._onModelUnloaded,this),this.mapping_info.hasOwnProperty("write")&&i.isBoolean(this.mapping_info.write)&&(this.mapping_info=i.clone(this.mapping_info),this.mapping_info.read_only=!this.mapping_info.write),e.ModelRef&&this.model instanceof e.ModelRef&&(this.model_ref=this.model,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),this.model=this.model_ref.getModel()),this.__kb.value_observable=r.observable(),this.mapping_info.localizer&&(this.__kb.localizer=new this.mapping_info.localizer(this._getCurrentValue())),u=n.utils.wrappedObservable(this,r.dependentObservable({read:i.bind(this._onGetValue,this),write:this.mapping_info.read_only?function(){throw"kb.Observable: "+a.mapping_info.key+" is read only"}:i.bind(this._onSetValue,this),owner:this.view_model})),u.destroy=i.bind(this.destroy,this),u.setToDefault=i.bind(this.setToDefault,this),(!this.model_ref||this.model_ref.isLoaded())&&this.model.bind("change",this.__kb._onModelChange),u}return t.prototype.destroy=function(){return this.__kb.value_observable=null,n.utils.wrappedObservable(this).dispose(),n.utils.wrappedObservable(this,null),this.model&&this.__kb._onModelUnloaded(this.model),this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),this.mapping_info=null,this.view_model=null,this.__kb=null},t.prototype.setToDefault=function(){var e;return e=this._getDefaultValue(),this.__kb.localizer&&(this.__kb.localizer.observedValue(e),e=this.__kb.localizer()),this.__kb.value_observable(e)},t.prototype._getDefaultValue=function(){return this.mapping_info.hasOwnProperty("default")?typeof this.mapping_info["default"]=="function"?this.mapping_info["default"]():this.mapping_info["default"]:""},t.prototype._getCurrentValue=function(){var e,t,n,s,o,u;if(!this.model)return this._getDefaultValue();n=r.utils.unwrapObservable(this.mapping_info.key),t=[n];if(!i.isUndefined(this.mapping_info.args))if(i.isArray(this.mapping_info.args)){u=this.mapping_info.args;for(s=0,o=u.length;s<o;s++)e=u[s],t.push(r.utils.unwrapObservable(e))}else t.push(r.utils.unwrapObservable(this.mapping_info.args));return this.mapping_info.read?this.mapping_info.read.apply(this.view_model,t):this.model.get.apply(this.model,t)},t.prototype._onGetValue=function(){var e,t,n,s,o;this.__kb.value_observable(),r.utils.unwrapObservable(this.mapping_info.key);if(!i.isUndefined(this.mapping_info.args))if(i.isArray(this.mapping_info.args)){o=this.mapping_info.args;for(n=0,s=o.length;n<s;n++)e=o[n],r.utils.unwrapObservable(e)}else r.utils.unwrapObservable(this.mapping_info.args);return t=this._getCurrentValue(),this.__kb.localizer&&(this.__kb.localizer.observedValue(t),t=this.__kb.localizer()),t},t.prototype._onSetValue=function(e){var t,n,s,o,u,a;this.__kb.localizer&&(this.__kb.localizer(e),e=this.__kb.localizer.observedValue());if(this.model){s={},s[r.utils.unwrapObservable(this.mapping_info.key)]=e,n=typeof this.mapping_info.write=="function"?[e]:[s];if(!i.isUndefined(this.mapping_info.args))if(i.isArray(this.mapping_info.args)){a=this.mapping_info.args;for(o=0,u=a.length;o<u;o++)t=a[o],n.push(r.utils.unwrapObservable(t))}else n.push(r.utils.unwrapObservable(this.mapping_info.args));typeof this.mapping_info.write=="function"?this.mapping_info.write.apply(this.view_model,n):this.model.set.apply(this.model,n)}return this.__kb.localizer?this.__kb.value_observable(this.__kb.localizer()):this.__kb.value_observable(e)},t.prototype._modelBind=function(t){if(!t)return;t.bind("change",this.__kb._onModelChange);if(e.RelationalModel&&t instanceof e.RelationalModel)return t.bind("add",this.__kb._onModelChange),t.bind("remove",this.__kb._onModelChange),t.bind("update",this.__kb._onModelChange)},t.prototype._modelUnbind=function(t){if(!t)return;t.unbind("change",this.__kb._onModelChange);if(e.RelationalModel&&t instanceof e.RelationalModel)return t.unbind("add",this.__kb._onModelChange),t.unbind("remove",this.__kb._onModelChange),t.unbind("update",this.__kb._onModelChange)},t.prototype._onModelLoaded=function(e){return this.model=e,this._modelBind(e),this._updateValue()},t.prototype._onModelUnloaded=function(e){return this.__kb.localizer&&this.__kb.localizer.destroy&&(this.__kb.localizer.destroy(),this.__kb.localizer=null),this._modelUnbind(e),this.model=null},t.prototype._onModelChange=function(){if(this.model&&this.model.hasChanged&&!this.model.hasChanged(r.utils.unwrapObservable(this.mapping_info.key)))return;return this._updateValue()},t.prototype._updateValue=function(){var e;return e=this._getCurrentValue(),this.__kb.localizer&&(this.__kb.localizer.observedValue(e),e=this.__kb.localizer()),this.__kb.value_observable(e)},t}(),n.observable=function(e,t,r){return new n.Observable(e,t,r)},n.Observables=function(){function e(e,t,r,s){var o,u,a,f,l,c,h,p,d;if(!e)throw"Observables: model is missing";if(!t||!i.isObject(t)&&!i.isArray(t))throw"Observables: mappings_info is missing";this.__kb||(this.__kb={}),this.__kb.model=e;if(i.isArray(t)){this.__kb.mappings_info={};for(c=0,h=t.length;c<h;c++)u=t[c],this.__kb.mappings_info[u]={}}else this.__kb.mappings_info=t;this.__kb.view_model=i.isUndefined(r)?this:r,!i.isUndefined(s)&&s.hasOwnProperty("write")&&(n.utils.legacyWarning("kb.Observables option.write","0.16.0","Now default is writable so only supply read_only as required"),s.read_only=!s.write,delete s.write);if(!i.isUndefined(s)){l=i.isBoolean(s)?s:s.read_only,p=this.__kb.mappings_info;for(f in p)a=p[f],o=i.isString(a),o?a=i.isUndefined(l)?{key:a}:{key:a,read_only:l}:!i.isUndefined(l)&&!a.hasOwnProperty("read_only")&&!a.hasOwnProperty("write")&&(a.read_only=l),a.hasOwnProperty("key")||(a.key=f),this[f]=this.__kb.view_model[f]=n.observable(this.__kb.model,a,this.__kb.view_model)}else{d=this.__kb.mappings_info;for(f in d)a=d[f],a.hasOwnProperty("write")&&n.utils.legacyWarning("kb.Observables option.write","0.16.0","Now default is writable so only supply read_only as required"),a.hasOwnProperty("key")||(a.key=f),this[f]=this.__kb.view_model[f]=n.observable(this.__kb.model,a,this.__kb.view_model)}}return e.prototype.destroy=function(){var e,t,n;n=this.__kb.mappings_info;for(t in n)e=n[t],this.__kb.view_model[t]&&this.__kb.view_model[t].destroy(),this.__kb.view_model[t]=null,this[t]=null;return this.__kb.view_model=null,this.__kb.mappings_info=null,this.__kb.model=null},e.prototype.setToDefault=function(){var e,t,n,r;n=this.__kb.mappings_info,r=[];for(t in n)e=n[t],r.push(this.__kb.view_model[t].setToDefault());return r},e}(),n.observables=function(e,t,r,i){return new n.Observables(e,t,r,i)},n.TriggeredObservable=function(){function t(t,s){var o;this.model=t,this.event_name=s;if(!this.model)throw"Observable: model is missing";if(!this.event_name)throw"Observable: event_name is missing";return this.__kb={},this.__kb._onValueChange=i.bind(this._onValueChange,this),this.__kb._onModelLoaded=i.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=i.bind(this._onModelUnloaded,this),e.ModelRef&&this.model instanceof e.ModelRef&&(this.model_ref=this.model,this.model_ref.retain(),this.model_ref.bind("loaded",this.__kb._onModelLoaded),this.model_ref.bind("unloaded",this.__kb._onModelUnloaded),this.model=this.model_ref.getModel()),this.__kb.value_observable=r.observable(),o=n.utils.wrappedObservable(this,r.dependentObservable(i.bind(this._onGetValue,this))),o.destroy=i.bind(this.destroy,this),(!this.model_ref||this.model_ref.isLoaded())&&this._onModelLoaded(this.model),o}return t.prototype.destroy=function(){return n.utils.wrappedObservable(this).dispose(),n.utils.wrappedObservable(this,null),this.__kb.value_observable=null,this.model&&this._onModelUnloaded(this.model),this.model_ref&&(this.model_ref.unbind("loaded",this.__kb._onModelLoaded),this.model_ref.unbind("unloaded",this.__kb._onModelUnloaded),this.model_ref.release(),this.model_ref=null),this.options=null,this.view_model=null,this.__kb=null},t.prototype._onGetValue=function(){return this.__kb.value_observable()},t.prototype._onModelLoaded=function(e){return this.model=e,this.model.bind(this.event_name,this.__kb._onValueChange),this._onValueChange()},t.prototype._onModelUnloaded=function(){return this.__kb.localizer&&this.__kb.localizer.destroy&&(this.__kb.localizer.destroy(),this.__kb.localizer=null),this.model.unbind(this.event_name,this.__kb._onValueChange),this.model=null},t.prototype._onValueChange=function(){var e;return e=this.__kb.value_observable(),e!==this.model?this.__kb.value_observable(this.model):this.__kb.value_observable.valueHasMutated()},t}(),n.triggeredObservable=function(e,t){return new n.TriggeredObservable(e,t)},n.AttributeConnector=function(){function t(e,t,s){var o;return this.key=t,this.options=s!=null?s:{},n.utils.wrappedModel(this,e),this.options=i.clone(this.options),this.__kb.value_observable=r.observable(),o=n.utils.wrappedObservable(this,r.dependentObservable({read:i.bind(this.read,this),write:i.bind(this.write,this)})),o.destroy=i.bind(this.destroy,this),o.model=i.bind(this.model,this),o.update=i.bind(this.update,this),this.__kb.initializing=!0,this.update(),this.__kb.initializing=!1,o}return t.prototype.destroy=function(){return this.__kb.value_observable=null,n.utils.wrappedObservable(this).dispose(),n.utils.wrappedObservable(this,null)},t.prototype.read=function(){return this.__kb.value_observable()},t.prototype.write=function(e){var t,r;t=n.utils.wrappedModel(this);if(!t)return;if(!this.options.read_only)return r={},r[this.key]=e,t.set(r);if(!this.__kb.initializing)throw"Cannot write a value to a dependentObservable unless you specify a 'write' option. If you wish to read the current value, don't pass any parameters."},t.prototype.model=function(e){var t;t=n.utils.wrappedModel(this);if(arguments.length===0)return t;if(t===e)return;return n.utils.wrappedModel(this,e),this.update()},t.inferType=function(t,n){var r,s;return s=t.get(n),s?s instanceof e.Collection?"collection":s instanceof e.Model||e.ModelRef&&s instanceof e.ModelRef?"model":"simple":e.RelationalModel&&t instanceof e.RelationalModel?(r=i.find(t.getRelations(),function(e){return e.key===n}),r?r.collectionKey?"collection":"model":"simple"):"simple"},t.createByType=function(e,t,r,s){var o;switch(e){case"collection":return o=s?i.clone(s):{},s.view_model||s.view_model_create||s.children||s.create||(o.view_model=n.ViewModel),s.store&&s.store.addResolverToOptions(o,t.get(r)),n.collectionAttributeConnector(t,r,o);case"model":return o=s?i.clone(s):{},o.options||(o.options={}),s.view_model||s.view_model_create||s.children||s.create||(o.view_model=n.ViewModel),s.store&&s.store.addResolverToOptions(o.options,t.get(r)),n.viewModelAttributeConnector(t,r,o);default:return n.simpleAttributeConnector(t,r,s)}},t.createOrUpdate=function(e,t,r,i){var s,o;if(e)return n.utils.observableInstanceOf(e,n.AttributeConnector)&&(e.model()!==t?e.model(t):e.update()),e;if(!t)return n.simpleAttributeConnector(t,r,i);if(i.hasOwnProperty("create")){if(!i.create)throw"kb.AttributeConnector: options.create is empty";return i.create(t,r,i.options||{})}o=t.get(r);if(i.hasOwnProperty("view_model")){if(!i.view_model)throw"kb.AttributeConnector: options.view_model is empty";return new i.view_model(o,i.options||{})}if(i.hasOwnProperty("view_model_create")){if(!i.view_model_create)throw"kb.AttributeConnector: options.view_model_create is empty";return i.view_model_create(o,i.options||{})}if(i.hasOwnProperty("children")){if(!i.children)throw"kb.AttributeConnector: options.children is empty";return typeof i.children=="function"?s={view_model:i.children}:s=i.children||{},n.collectionAttributeConnector(t,r,s)}return this.createByType(this.inferType(t,r),t,r,i)},t}(),n.SimpleAttributeConnector=function(e){function t(){return t.__super__.constructor.apply(this,arguments),n.utils.wrappedObservable(this)}return o(t,e),t.prototype.destroy=function(){return this.current_value=null,t.__super__.destroy.apply(this,arguments)},t.prototype.update=function(){var e,t,r;t=n.utils.wrappedModel(this);if(!t)return;r=t.get(this.key),e=this.__kb.value_observable();if(!i.isEqual(e,r))return this.__kb.value_observable(r)},t.prototype.write=function(e){var r;r=n.utils.wrappedModel(this);if(!r){this.__kb.value_observable(e);return}return t.__super__.write.apply(this,arguments)},t}(n.AttributeConnector),n.simpleAttributeConnector=function(e,t,r){return new n.SimpleAttributeConnector(e,t,r)},n.CollectionAttributeConnector=function(e){function t(){return t.__super__.constructor.apply(this,arguments),n.utils.wrappedObservable(this)}return o(t,e),t.prototype.destroy=function(){var e;return e=this.__kb.value_observable(),e&&typeof e.refCount=="function"&&e.refCount()>0&&e.release(),t.__super__.destroy.apply(this,arguments)},t.prototype.update=function(){var e,t,r,i=this;t=n.utils.wrappedModel(this);if(!t)return;r=t.get(this.key),e=this.__kb.value_observable();if(!e)return this.options.store?this.__kb.value_observable(this.options.store.resolveValue(r,function(){return n.collectionObservable(r,i.options)})):this.__kb.value_observable(n.collectionObservable(r,this.options));if(e.collection()!==r)return e.collection(r),this.__kb.value_observable.valueHasMutated()},t.prototype.read=function(){var e;return e=this.__kb.value_observable(),e?e():void 0},t}(n.AttributeConnector),n.collectionAttributeConnector=function(e,t,r){return new n.CollectionAttributeConnector(e,t,r)},n.ViewModelAttributeConnector=function(e){function t(){return t.__super__.constructor.apply(this,arguments),n.utils.wrappedObservable(this)}return o(t,e),t.prototype.destroy=function(){var e;return e=this.__kb.value_observable(),e&&typeof e.refCount=="function"&&e.refCount()>0&&e.release(),t.__super__.destroy.apply(this,arguments)},t.prototype.update=function(){var e,t,r,s,o=this;t=n.utils.wrappedModel(this);if(!t)return;r=t.get(this.key),e=this.__kb.value_observable();if(!e)return s=this.options.options?i.clone(this.options.options):{},s.store?this.__kb.value_observable(s.store.resolveValue(r,function(){return o.options.view_model?new o.options.view_model(r,s):o.options.view_model_create(r,s)})):this.__kb.value_observable(this.options.view_model?new this.options.view_model(r,s):this.options.view_model_create(r,s));if(!e.model||typeof e.model!="function")throw"kb.viewModelAttributeConnector: unknown how to model a view model";if(e.model()!==r)return e.model(r),this.__kb.value_observable.valueHasMutated()},t}(n.AttributeConnector),n.viewModelAttributeConnector=function(e,t,r){return new n.ViewModelAttributeConnector(e,t,r)},n.ViewModel=function(t){function r(t,s){var o,u,a,f;s==null&&(s={}),r.__super__.constructor.apply(this,arguments),n.stats_on&&n.stats.view_models++,s.store_skip_resolve||n.Store.resolveFromOptions(s,this),s.store?this.__kb.store=s.store:(this.__kb.store=new n.Store,this.__kb.store_is_owned=!0),this.__kb._onModelChange=i.bind(this._onModelChange,this),this.__kb._onModelLoaded=i.bind(this._onModelLoaded,this),this.__kb._onModelUnloaded=i.bind(this._onModelUnloaded,this),this.__kb.internals=s.internals,this.__kb.requires=s.requires,this.__kb.children=s.children,this.__kb.create=s.create,this.__kb.read_only=s.read_only,n.utils.wrappedModel(this,t),e.ModelRef&&t instanceof e.ModelRef&&(this.__kb.model_ref=t,this.__kb.model_ref.retain(),n.utils.wrappedModel(this,this.__kb.model_ref.getModel()),this.__kb.model_ref.bind("loaded",this.__kb._onModelLoaded),this.__kb.model_ref.bind("unloaded",this.__kb._onModelUnloaded)),this.__kb.model&&this._onModelLoaded(this.__kb.model);if(!this.__kb.internals&&!this.__kb.requires)return this;u=i.union(this.__kb.internals?this.__kb.internals:[],this.__kb.requires?this.__kb.requires:[]);if(!this.__kb.model_ref||this.__kb.model_ref.isLoaded())u=i.difference(u,i.keys(this.__kb.model.attributes));for(a=0,f=u.length;a<f;a++)o=u[a],this._updateAttributeConnector(this.__kb.model,o)}return o(r,t),r.prototype.__destroy=function(){var e;e=this.__kb.model,n.utils.wrappedModel(this,null),this._modelUnbind(e),this.__kb.store_is_owned&&this.__kb.store.destroy(),this.__kb.store=null,n.utils.release(this,!0),r.__super__.__destroy.apply(this,arguments);if(n.stats_on)return n.stats.view_models--},r.prototype.model=function(e){var t;t=n.utils.wrappedModel(this);if(arguments.length===0)return t;if(e===t)return;t&&this._onModelUnloaded(t);if(e)return this._onModelLoaded(e)},r.prototype._modelBind=function(t){if(!t)return;t.bind("change",this.__kb._onModelChange);if(e.RelationalModel&&t instanceof e.RelationalModel)return t.bind("add",this.__kb._onModelChange),t.bind("remove",this.__kb._onModelChange),t.bind("update",this.__kb._onModelChange)},r.prototype._modelUnbind=function(t){if(!t)return;t.unbind("change",this.__kb._onModelChange);if(e.RelationalModel&&t instanceof e.RelationalModel)return t.unbind("add",this.__kb._onModelChange),t.unbind("remove",this.__kb._onModelChange),t.unbind("update",this.__kb._onModelChange)},r.prototype._onModelLoaded=function(e){var t,r;n.utils.wrappedModel(this,e),this._modelBind(e),r=[];for(t in this.__kb.model.attributes)r.push(this._updateAttributeConnector(this.__kb.model,t));return r},r.prototype._onModelUnloaded=function(e){var t,r;this._modelUnbind(e),n.utils.wrappedModel(this,null),r=[];for(t in e.attributes)r.push(this._updateAttributeConnector(null,t));return r},r.prototype._onModelChange=function(){var e,t,n;if(this.__kb.model._changed){t=[];for(e in this.__kb.model.attributes)t.push(this.__kb.model.hasChanged(e)?this._updateAttributeConnector(this.__kb.model,e):void 0);return t}if(this.__kb.model.changed){n=[];for(e in this.__kb.model.changed)n.push(this._updateAttributeConnector(this.__kb.model,e));return n}},r.prototype._updateAttributeConnector=function(e,t){var r;return r=this.__kb.internals&&i.contains(this.__kb.internals,t)?"_"+t:t,this[r]=n.AttributeConnector.createOrUpdate(this[r],e,t,this._createOptions(t))},r.prototype._createOptions=function(e){var t;if(this.__kb.children){if(this.__kb.children.hasOwnProperty(e))return t=this.__kb.children[e],typeof t=="function"&&(t={view_model:t}),t.options={read_only:this.__kb.read_only,store:this.__kb.store},t;if(this.__kb.children.hasOwnProperty("create"))return{create:this.__kb.children.create,options:{read_only:this.__kb.read_only,store:this.__kb.store}}}else if(this.__kb.create)return{create:this.__kb.create,options:{read_only:this.__kb.read_only,store:this.__kb.store}};return{read_only:this.__kb.read_only,store:this.__kb.store}},r}(n.RefCountable),n.viewModel=function(e,t){return new n.ViewModel(e,t)}}).call(this);